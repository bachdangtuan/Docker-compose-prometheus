groups:
  - name: Phòng Khám 40-Rules
    rules:
      # Node Down
      - alert: Node-export bị tắt
        expr:  up{job="Phong-Kham-40",instance=~".+"} == 0
        for: 1m
        labels:
          severity: Rất Nguy Hiểm
          app_type: Phòng Khám 40
          category: server
          instance: "{{ $labels.instance }}"
        annotations:
          summary: "Node-export trên server {{ $labels.instance }} bị tắt"
          description: | 
                Vui lòng kiểm tra lại node-exporter trên server hoặc kiểm tra server có bị tắt hay không ?

      # Ram Rules
      - alert: Cảnh báo RAM
        expr: (node_memory_MemTotal_bytes{job="Phong-Kham-40", instance=~".+"} - node_memory_MemFree_bytes{job="Phong-Kham-40", instance=~".+"}) / (node_memory_MemTotal_bytes{job="Phong-Kham-40", instance=~".+"}) * 100 >= 80
        for: 1m
        labels:
          severity: Rất Nguy Hiểm
          app_type: Phòng Khám 40
          category: memory
          instance: "{{ $labels.instance }}"
        annotations:
          summary: "RAM Server > 80%"
          description: |
            RAM đã sử dụng chiếm {{ printf "%.2f" $value }}% / 100%
                 * Ram sử dụng (ram dùng + ram cache/buffer)
            Thông tin cụ thể:

                 * TOTAL RAM:  {{ query (printf "node_memory_MemTotal_bytes{job='Phong-Kham-40', instance=~'%s'}" $labels.instance) | first | value | humanize }}

                 * Ram sử dụng:  {{ query (printf "node_memory_MemTotal_bytes{job='Phong-Kham-40', instance=~'%s'} - node_memory_MemFree_bytes{job='Phong-Kham-40', instance=~'%s'}" $labels.instance $labels.instance ) | first | value | humanize }}
                  
                 * Ram còn lại:  {{ query (printf "node_memory_MemFree_bytes{job='Phong-Kham-40', instance=~'%s'}" $labels.instance) | first | value | humanize }}

      # CPU Rules
      - alert: CPU Tăng cao
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{job="Phong-Kham-40", instance=~".+",mode="idle"}[1m])) * 100) > 80
        for: 1m
        labels:
          severity: Rất Nguy Hiểm
          app_type: Phòng Khám 40
          category: cpu
          instance: "{{ $labels.instance }}"
        annotations:
          summary: "CPU Server > 90%"
          description: | 
            CPU máy chủ sử dụng đạt tới  {{ printf "%.2f" $value }}% / 100%

      # Disk Rules
      - alert: Dung Lượng ổ cứng còn lại nhỏ hơn 95%
        expr: ((node_filesystem_free_bytes{instance=~".+",job="Phong-Kham-40",mountpoint="/"}) / (node_filesystem_size_bytes{instance=~".+",job="Phong-Kham-40",mountpoint="/"})) * 100 > 95
        for: 1m
        labels:
          severity: Rất Nguy Hiểm
          app_type: Phòng Khám 40
          category: disk
        annotations:
          summary: "Dung lượng ổ cứng server còn lại < 95%"
          description: | 
           Dung lượng sắp đầy (< 10% left)\n  Dung lượng còn trống {{ printf "%.2f" $value }}% / 100%
